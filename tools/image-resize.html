<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicProTools - High Fidelity Resizer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pica/9.0.1/pica.min.js"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        primary: { 500: '#6366f1', 600: '#4f46e5' }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        /* Custom Scrollbar for preview */
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-50 min-h-screen flex items-center justify-center p-4 font-sans antialiased">

    <div x-data="imageResizer()" class="w-full max-w-6xl">
        
        <div class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400 mb-2">
                PicProTools
            </h1>
            <p class="text-slate-400 text-sm">Professional Lanczos3 Resizing (Browser-Based)</p>
        </div>

        <div class="bg-slate-900 border border-slate-800 rounded-3xl shadow-2xl overflow-hidden relative">
            
            <div x-show="isProcessing" class="absolute inset-0 z-50 bg-slate-900/90 flex flex-col items-center justify-center backdrop-blur-sm" x-transition x-cloak>
                <svg class="animate-spin h-10 w-10 text-primary-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-primary-500 font-bold tracking-wider">PROCESSING HD...</span>
            </div>

            <div x-show="step === 'upload'" class="p-12 text-center transition-all duration-300">
                <div 
                    @dragover.prevent="dragHover = true"
                    @dragleave.prevent="dragHover = false"
                    @drop.prevent="dragHover = false; handleFile($event.dataTransfer.files[0])"
                    @click="$refs.fileInput.click()"
                    :class="{'border-primary-500 bg-slate-800/50': dragHover, 'border-slate-700 hover:border-slate-600 hover:bg-slate-800/30': !dragHover}"
                    class="border-2 border-dashed rounded-2xl p-16 cursor-pointer transition-all duration-200 group"
                >
                    <input x-ref="fileInput" type="file" class="hidden" accept="image/*" @change="handleFile($event.target.files[0])">
                    
                    <div class="mb-6 transform group-hover:scale-110 transition-transform duration-200">
                        <svg class="w-20 h-20 mx-auto text-slate-500 group-hover:text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.587-1.587a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-200 mb-2">Upload Image</h3>
                    <p class="text-slate-500">JPG, PNG, WebP supported</p>
                </div>
            </div>

            <div x-show="step === 'editor'" class="grid grid-cols-1 lg:grid-cols-12 min-h-[600px]" x-cloak>
                
                <div class="lg:col-span-8 bg-black/40 p-6 flex flex-col items-center justify-center relative border-r border-slate-800">
                    <div class="relative w-full h-full flex items-center justify-center custom-scroll overflow-auto">
                        <canvas x-ref="previewCanvas" class="max-w-full max-h-[70vh] shadow-2xl rounded-lg"></canvas>
                        
                        <div x-show="!hasRendered" class="text-slate-500 text-sm absolute">
                            Adjust settings to generate preview
                        </div>
                    </div>
                    
                    <div class="mt-4 flex items-center gap-4 text-xs font-mono text-slate-400 bg-slate-900 px-4 py-2 rounded-full border border-slate-800">
                        <span>ORIGINAL: <span x-text="formatBytes(originalSize)"></span></span>
                        <span class="text-slate-600">|</span>
                        <span>OUTPUT: <span x-text="outputSize ? formatBytes(outputSize) : '...'" :class="{'text-green-400': outputSize < originalSize, 'text-yellow-400': outputSize >= originalSize}"></span></span>
                    </div>
                </div>

                <div class="lg:col-span-4 bg-slate-900 p-6 flex flex-col gap-6 overflow-y-auto max-h-[80vh] custom-scroll">
                    
                    <div class="space-y-3">
                        <label class="text-xs font-bold text-slate-500 tracking-wider uppercase">Dimensions</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] text-slate-500 mb-1 block">WIDTH</label>
                                <input type="number" x-model="width" @input="updateDims('w')" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-primary-500 focus:outline-none transition-colors">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 mb-1 block">HEIGHT</label>
                                <input type="number" x-model="height" @input="updateDims('h')" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-primary-500 focus:outline-none transition-colors">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="lock" x-model="lockRatio" class="rounded bg-slate-800 border-slate-700 text-primary-500 focus:ring-0 cursor-pointer">
                            <label for="lock" class="text-xs text-slate-400 cursor-pointer select-none">Lock Aspect Ratio</label>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <label class="text-xs font-bold text-slate-500 tracking-wider uppercase">Quick Presets</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button @click="applyPreset(1080, 1080)" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-md text-xs text-slate-300 transition-colors">Instagram (Sq)</button>
                            <button @click="applyPreset(1920, 1080)" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-md text-xs text-slate-300 transition-colors">Full HD</button>
                            <button @click="applyPercentage(0.5)" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-md text-xs text-slate-300 transition-colors">50% Scale</button>
                            <button @click="applyPercentage(0.25)" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-md text-xs text-slate-300 transition-colors">25% Scale</button>
                        </div>
                    </div>

                    <hr class="border-slate-800">

                    <div class="space-y-4">
                        <label class="text-xs font-bold text-slate-500 tracking-wider uppercase">Export Settings</label>
                        
                        <div class="relative">
                            <select x-model="format" class="w-full appearance-none bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-primary-500 focus:outline-none">
                                <option value="image/jpeg">JPEG (Photographs)</option>
                                <option value="image/png">PNG (Lossless/Transparent)</option>
                                <option value="image/webp">WebP (Modern Optimized)</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>

                        <div x-show="format !== 'image/png'" class="space-y-2">
                            <div class="flex justify-between text-xs text-slate-400">
                                <span>Quality</span>
                                <span x-text="quality + '%'"></span>
                            </div>
                            <input type="range" x-model="quality" min="1" max="100" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-primary-500">
                        </div>

                        <div class="flex items-center justify-between bg-slate-800/50 p-3 rounded-lg border border-slate-800">
                            <span class="text-sm text-slate-300">Smart Sharpen</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" x-model="sharpen" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer left-0 top-0 transition-transform duration-200" :class="{'translate-x-full border-primary-500': sharpen, 'border-slate-400': !sharpen}"/>
                                <label class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-700 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto space-y-3 pt-6">
                        <button @click="processImage()" class="w-full bg-primary-600 hover:bg-primary-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-primary-500/20 transition-all transform active:scale-95 flex items-center justify-center gap-2">
                            <span>âš¡ Render Preview</span>
                        </button>

                        <button x-show="hasRendered" @click="download()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-emerald-500/20 transition-all transform active:scale-95 flex items-center justify-center gap-2">
                            <span>ðŸ“¥ Download Image</span>
                        </button>

                        <button @click="reset()" class="w-full bg-transparent border border-rose-500/30 text-rose-400 hover:bg-rose-500/10 font-semibold py-2 px-4 rounded-lg text-sm transition-colors">
                            Restart / New Image
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <div class="text-center mt-6 text-slate-600 text-xs">
            &copy; 2026 PicProTools. Local processing only.
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('imageResizer', () => ({
                step: 'upload',
                dragHover: false,
                isProcessing: false,
                hasRendered: false,
                
                // Data
                file: null,
                originalImage: null, // The HTMLImageElement
                originalWidth: 0,
                originalHeight: 0,
                originalSize: 0,
                outputSize: 0,
                
                // Settings
                width: 0,
                height: 0,
                lockRatio: true,
                format: 'image/jpeg',
                quality: 90,
                sharpen: false,
                
                // Pica Instance
                pica: null,

                init() {
                    // Initialize Pica with webworkers enabled for speed
                    this.pica = window.pica({ features: ['js', 'wasm', 'cib'] });
                },

                formatBytes(bytes, decimals = 2) {
                    if (!+bytes) return '0 Bytes';
                    const k = 1024;
                    const dm = decimals < 0 ? 0 : decimals;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
                },

                handleFile(file) {
                    if (!file || !file.type.match('image.*')) return;
                    
                    this.file = file;
                    this.originalSize = file.size;
                    
                    // Smart Format Detection
                    if(file.type === 'image/png') this.format = 'image/png';
                    else if(file.type === 'image/webp') this.format = 'image/webp';
                    else this.format = 'image/jpeg';

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.originalImage = new Image();
                        this.originalImage.onload = () => {
                            this.originalWidth = this.originalImage.width;
                            this.originalHeight = this.originalImage.height;
                            
                            // Set initial inputs
                            this.width = this.originalWidth;
                            this.height = this.originalHeight;
                            
                            this.step = 'editor';
                            
                            // Initial quick render
                            this.$nextTick(() => {
                                this.processImage();
                            });
                        };
                        this.originalImage.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                },

                updateDims(type) {
                    if (!this.lockRatio) return;
                    const ratio = this.originalWidth / this.originalHeight;
                    if (type === 'w') {
                        this.height = Math.round(this.width / ratio);
                    } else {
                        this.width = Math.round(this.height * ratio);
                    }
                },

                applyPreset(w, h) {
                    this.lockRatio = false;
                    this.width = w;
                    this.height = h;
                    // Auto process on preset click for snappy feel
                    this.processImage();
                },

                applyPercentage(pct) {
                    this.lockRatio = true;
                    this.width = Math.round(this.originalWidth * pct);
                    this.height = Math.round(this.originalHeight * pct);
                    this.processImage();
                },

                async processImage() {
                    if (!this.originalImage) return;
                    this.isProcessing = true;

                    // Small delay to let UI show loading state
                    await new Promise(r => setTimeout(r, 50));

                    try {
                        const canvas = this.$refs.previewCanvas;
                        
                        // 1. Resize using Pica (High Quality Lanczos3)
                        canvas.width = this.width;
                        canvas.height = this.height;
                        
                        await this.pica.resize(this.originalImage, canvas, {
                            unsharpAmount: this.sharpen ? 80 : 0, // Pica has built-in unsharp mask!
                            unsharpRadius: 0.6,
                            unsharpThreshold: 2
                        });

                        // 2. Calculate Size estimation
                        // We use toBlob to get the real size info
                        const blob = await this.pica.toBlob(canvas, this.format, this.quality / 100);
                        this.outputSize = blob.size;
                        this.hasRendered = true;

                    } catch (err) {
                        console.error("Resize failed", err);
                        alert("Error processing image. The dimensions might be too large for this device.");
                    } finally {
                        this.isProcessing = false;
                    }
                },

                async download() {
                    if(!this.hasRendered) return;
                    
                    const canvas = this.$refs.previewCanvas;
                    const blob = await this.pica.toBlob(canvas, this.format, this.quality / 100);
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    // Generate nice filename
                    const ext = this.format.split('/')[1];
                    const timestamp = new Date().getTime();
                    link.download = `PicPro_${this.width}x${this.height}_${timestamp}.${ext}`;
                    
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                },

                reset() {
                    this.step = 'upload';
                    this.file = null;
                    this.originalImage = null;
                    this.hasRendered = false;
                    this.outputSize = 0;
                    // Reset file input value so same file can be selected again
                    this.$refs.fileInput.value = '';
                }
            }));
        });
    </script>
</body>
</html>
